---
import Layout from "../components/Layout.astro";

import { locale } from "../utils/locale";
import { accessTokenName, refreshTokenName } from "../utils/config";
import { getUser } from "../utils/supabaseServer";

const accessToken = Astro.cookies.get(accessTokenName)?.value;
const refreshToken = Astro.cookies.get(refreshTokenName)?.value;

const userData = await getUser({ accessToken, refreshToken });
const isLoggedIn = !!userData;
---

<Layout title="update" isLoggedIn={isLoggedIn}>
  <div
    style={{
      display: "flex",
      alignItems: "stretch",
      justifyContent: "center",
    }}
  >
    <form
      class="form-widget"
      style={{
        boxShadow: "1px 1px 3px #ccc",
        borderRadius: "8px",
        padding: "20px",
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        maxWidth: "35rem",
        gap: "1rem",
      }}
    >
      <label
        style={{
          display: "flex",
          flexDirection: "column",
        }}
      >
        {locale.update_password?.password_label}
        <input id="password" name="password" type="password" required />
      </label>
      <button
        type="submit"
        style={{
          backgroundColor: "var(--accent)",
          border: "none",
          padding: "6px 10px",
          fontSize: "large",
          color: "white",
          cursor: "pointer",
          borderRadius: "6px",
        }}
      >
        <span>{locale.update_password?.button_label}</span>
      </button>
    </form>
  </div>
</Layout>

<script>
  import { supabase } from "../utils/supabaseBrowser";
  import { locale } from "../utils/locale";

  const form = document.querySelector(".form-widget");
  const submitBtn = document.querySelector(".form-widget button");
  form!.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    const password = formData.get("password") as string;
    if (password) {
      try {
        submitBtn!.textContent =
          locale?.update_password?.loading_button_label ?? "";
        const { error } = await supabase.auth.updateUser({
          password: password,
        });
        if (error) throw error;
        alert("✅");
      } catch (error) {
        if (error instanceof Error) {
          alert(error.message);
        }
      } finally {
        submitBtn!.textContent = "✅";
      }
    }
  });
</script>
