---
import Layout from "../components/Layout.astro";

import { locale } from "../utils/locale";
import { accessTokenName, refreshTokenName } from "../utils/config";
import { supabase } from "../utils/supabaseServer";

const accessToken = Astro.cookies.get(accessTokenName)?.value;
const refreshToken = Astro.cookies.get(refreshTokenName)?.value;

type FormText = {
  buttonText: string;
  confirm?: string;
  error?: string;
};

const formText: FormText = {
  buttonText: locale.update_password?.button_label ?? "Submit",
  confirm: undefined,
  error: undefined,
};

if (accessToken && refreshToken) {
  supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
}

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();

    const password = data.get("password");

    if (typeof password === "string") {
      formText.buttonText =
        locale.update_password?.loading_button_label ?? "Loading";
      const { error } = await supabase.auth.updateUser({
        password: password,
      });
      formText.buttonText = locale.update_password?.button_label ?? "Submit";
      if (error) {
        formText.error = error.message;
      } else {
        formText.confirm = locale.update_password?.confirmation_text;
      }
    }
  } catch (error) {
    if (error instanceof Error) {
      formText.error = error.message;
      console.error(error.message);
    }
  }
}
---

<Layout title="update">
  <div
    style={{
      display: "flex",
      alignItems: "stretch",
      justifyContent: "center",
    }}
  >
    <form
      class="form-widget"
      method="post"
      style={{
        boxShadow: "1px 1px 3px #ccc",
        borderRadius: "8px",
        padding: "20px",
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        maxWidth: "35rem",
        gap: "1rem",
      }}
    >
      <label
        style={{
          display: "flex",
          flexDirection: "column",
        }}
      >
        {locale.update_password?.password_label}
        <input id="password" name="password" type="password" required />
      </label>
      <button
        type="submit"
        style={{
          backgroundColor: "var(--accent)",
          border: "none",
          padding: "6px 10px",
          fontSize: "large",
          color: "white",
          cursor: "pointer",
          borderRadius: "6px",
        }}
      >
        <span>{formText.buttonText}</span>
      </button>
      {formText.error && <label>{formText.error}</label>}
      {formText.confirm && <label>{formText.confirm}</label>}
    </form>
  </div>
</Layout>
